<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ë¬´í•œ íŒŒë”±: CHIMERA & ALLIANCE</title>
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@400;700;900&family=Jua&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #050505; --panel: #121212;
            --n: #95a5a6; --r: #3498db; --sr: #9b59b6; --ssr: #f1c40f; --ur: #00cec9; --f: #e74c3c;
            --text: #ecf0f1; --border: #333;
            --success: #2ecc71; --danger: #eb4d4b; --accent: #e67e22;
            --coop-bad: #d63031; /* ì¢†ëª©ì§ˆ ìƒ‰ìƒ */
            --coop-good: #00cec9; /* ì •ì˜êµ¬í˜„ ìƒ‰ìƒ */
        }
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0; background: var(--bg); color: var(--text);
            font-family: 'Noto Sans KR', sans-serif;
            min-height: 100vh; overflow-y: auto; padding-bottom: 160px;
        }
        
        h1, h2, .font-title, .font-pixel { font-family: 'Black Han Sans', sans-serif; }
        
        /* HEADER */
        header {
            position: sticky; top: 0; z-index: 100;
            background: rgba(5, 5, 5, 0.95); border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center; padding: 8px 15px;
            backdrop-filter: blur(10px);
        }
        .header-left { display: flex; flex-direction: column; }
        .cp-display { font-size: 1.1rem; color: var(--ssr); text-shadow: 0 0 10px rgba(241, 196, 15, 0.3); letter-spacing: 1px; }
        
        .header-right { display: flex; align-items: center; gap: 10px; }
        
        /* STRESS BAR (New) */
        .stress-container { 
            width: 100px; height: 16px; background: #222; border-radius: 4px; 
            overflow: hidden; position: relative; border: 1px solid #444;
        }
        .stress-bar { height: 100%; width: 0%; background: linear-gradient(90deg, #e67e22, #e74c3c); transition: width 0.2s; }
        .stress-label { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            font-size: 9px; color: #fff; text-shadow: 1px 1px 2px #000; letter-spacing: 1px; white-space: nowrap;
        }

        .reset-btn {
            background: #2d3436; color: #888; border: 1px solid #444; 
            padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer;
        }

        /* TICKER (New) */
        .ticker-wrap {
            background: #000; border-bottom: 1px solid var(--border);
            overflow: hidden; display: flex; align-items: center; height: 28px;
        }
        .ticker {
            white-space: nowrap; animation: ticker 25s linear infinite;
            padding-left: 100%; color: var(--danger); font-size: 0.8rem; font-weight: bold;
        }
        @keyframes ticker { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        /* FUSION ALTAR */
        .altar-area {
            margin: 10px 15px; padding: 12px; background: linear-gradient(135deg, #181818, #000);
            border: 1px solid var(--sr); border-radius: 12px;
            display: flex; flex-direction: column; gap: 8px;
            box-shadow: 0 0 15px rgba(155, 89, 182, 0.2);
        }
        .altar-title { font-size: 0.9rem; color: var(--sr); display: flex; justify-content: space-between; align-items: center; }
        .altar-slots { display: flex; gap: 10px; justify-content: center; height: 50px; }
        .altar-slot { 
            width: 50px; height: 50px; border: 2px dashed #444; border-radius: 8px; 
            display: flex; align-items: center; justify-content: center; font-size: 0.7rem; color: #444;
            background: #111;
        }
        .altar-slot.filled { border-style: solid; color: #fff; font-weight: bold; background: #222; }
        
        .btn-fuse {
            background: var(--sr); color: #fff; border: none; padding: 8px; border-radius: 8px;
            font-size: 0.9rem; font-weight: bold; cursor: pointer; width: 100%;
            box-shadow: 0 4px 0 #8e44ad; transition: 0.1s;
        }
        .btn-fuse:active { transform: translateY(4px); box-shadow: none; }
        .btn-fuse:disabled { filter: grayscale(1); opacity: 0.3; pointer-events: none; transform: translateY(2px); box-shadow:none;}

        /* CARD GRID */
        main { padding: 0 15px; display: flex; flex-direction: column; gap: 15px; }
        .slot-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        
        .card {
            background: var(--panel); border: 1px solid #333; border-radius: 8px; padding: 8px;
            position: relative; display: flex; flex-direction: column; gap: 4px; min-height: 110px;
            transition: 0.2s; cursor: pointer; overflow: hidden;
        }
        .card.selected { border: 2px solid var(--success); background: #0f2215; transform: scale(0.98); }
        
        /* Rank Styles */
        .card.UR { border: 2px solid var(--ur); background: radial-gradient(circle at top right, #004444, #000); box-shadow: 0 0 10px var(--ur); animation: glow 2s infinite alternate;}
        .card.SSR { border: 2px solid var(--ssr); background: radial-gradient(circle at top right, #3a2a05, #111); }
        .card.F { border: 2px solid var(--f); background: #220505; }
        
        .c-header { display: flex; justify-content: space-between; align-items: center; }
        .c-rank { font-size: 0.75rem; padding: 2px 5px; border-radius: 3px; color: #000; font-weight: bold; }
        .c-rank.UR { background: var(--ur); color: #000; box-shadow: 0 0 8px var(--ur); }
        .c-rank.SSR { background: var(--ssr); } 
        .c-rank.SR { background: var(--sr); color:#fff;}
        .c-rank.R { background: var(--r); color:#fff;} 
        .c-rank.N { background: var(--n); } 
        .c-rank.F { background: var(--f); color:#fff;}
        
        .c-lv { font-size: 0.7rem; color: #aaa; }
        .c-name { font-size: 0.95rem; font-weight: bold; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; color: #ddd;}
        .c-job { font-size: 0.7rem; color: #777; }
        .c-status { font-size: 0.7rem; color: #aaa; margin-top: auto; display: flex; justify-content: space-between; align-items: flex-end;}

        /* Fire Button (New) */
        .btn-fire {
            background: #333; color: #bbb; border: 1px solid #555; font-size: 0.6rem;
            padding: 2px 6px; border-radius: 4px; cursor: pointer; z-index: 10;
        }
        .btn-fire:hover { background: var(--f); color: white; border-color: var(--f); }

        @keyframes glow { from { box-shadow: 0 0 5px var(--ur); } to { box-shadow: 0 0 15px var(--ur); } }

        /* LOGS */
        #section-logs {
            background: #000; padding: 10px; border: 1px solid #333; border-radius: 8px;
            font-family: 'Noto Sans KR', monospace; font-size: 0.8rem; line-height: 1.5;
            height: 180px; overflow-y: auto;
        }
        .log { margin-bottom: 3px; border-bottom: 1px dashed #222; padding-bottom: 2px; }
        .l-sys { color: #555; } 
        .l-ur { color: var(--ur); font-weight: bold; }
        .l-ssr { color: var(--ssr); } 
        .l-fail { color: var(--f); } 
        .l-up { color: var(--success); }
        .l-coop-bad { color: var(--coop-bad); font-weight: bold; border-left: 2px solid var(--coop-bad); padding-left: 4px;}
        .l-coop-good { color: var(--coop-good); font-weight: bold; border-left: 2px solid var(--coop-good); padding-left: 4px;}

        /* FOOTER */
        footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            display: grid; grid-template-columns: 1fr 1.2fr; gap: 10px;
            padding: 15px; background: rgba(10,10,10,0.95); border-top: 1px solid #333; z-index: 90;
        }
        .btn-gacha {
            height: 60px; border: none; border-radius: 10px; color: #fff; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 4px 0 rgba(0,0,0,0.5); transition: 0.1s;
        }
        .btn-gacha:active { transform: translateY(4px); box-shadow: none; }
        .btn-gacha:disabled { filter: grayscale(1); opacity: 0.5; }
        
        #btn-norm { background: #34495e; border: 1px solid #555; }
        #btn-prem { background: linear-gradient(135deg, #00cec9, #0984e3); border: 1px solid #00cec9; }

        /* OVERLAYS & EFFECTS */
        .overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }
        .overlay.active { display: flex; animation: fadeIn 0.1s forwards; }
        .pop-card {
            background: #222; border-radius: 20px; padding: 30px; text-align: center; border: 4px solid #fff;
            min-width: 280px; box-shadow: 0 0 50px rgba(255,255,255,0.2); animation: popIn 0.3s forwards;
        }
        .pop-rank { font-size: 4rem; font-family: 'Black Han Sans'; margin-bottom: 5px; }
        
        .float-txt {
            position: absolute; font-weight: 900; pointer-events: none; z-index: 50;
            text-shadow: 1px 1px 2px #000; animation: floatUp 1s forwards; font-size: 1rem;
        }

        #gameover { z-index: 2000; }

        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-40px); } }
    </style>
</head>
<body>

    <header>
        <div class="header-left">
            <div class="font-title cp-display">ğŸ’ <span id="ui-cp">0</span> CP</div>
        </div>
        <div class="header-right">
            <div class="stress-container">
                <div id="ui-stress" class="stress-bar"></div>
                <div class="stress-label">MENTAL</div>
            </div>
            <button class="reset-btn" onclick="game.hardReset()">ì´ˆê¸°í™”</button>
        </div>
    </header>

    <div class="ticker-wrap">
        <div class="ticker" id="ui-ticker">ğŸ“¢ ì‹œìŠ¤í…œ: ìœµí•© ê¸°ëŠ¥ê³¼ í˜‘ë™ ì—…ë°ì´íŠ¸ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
    </div>

    <div class="altar-area">
        <div class="altar-title font-pixel">
            <span>ğŸ”® ì˜í˜¼ ìœµí•© (ê³ ë‹‰ ì„¸íƒê¸°)</span>
            <span style="font-size:0.7rem; color:#888;">2ëª… ì„ íƒí•˜ì—¬ í•©ì²´</span>
        </div>
        <div class="altar-slots">
            <div id="slot-1" class="altar-slot">ì„ íƒ1</div>
            <div style="display:flex; align-items:center; color:#555;">+</div>
            <div id="slot-2" class="altar-slot">ì„ íƒ2</div>
        </div>
        <button id="btn-fuse" class="btn-fuse font-pixel" onclick="game.fuse()" disabled>
            ìœµí•© ì‹œì‘ (ë¹„ìš©: 300 CP)
        </button>
    </div>

    <main>
        <div style="display:flex; justify-content:space-between; color:#888; font-size:0.8rem; margin-bottom:5px;">
            <span>ë³´ìœ  íŒŒë”± (<span id="ui-count">0</span>/12)</span>
            <span>ì¹´ë“œë¥¼ ëˆŒëŸ¬ ì„ íƒ / ìš°ì¸¡í•˜ë‹¨ í•´ê³ </span>
        </div>
        <div id="slot-grid" class="slot-grid"></div>
        
        <div style="margin-top:10px;">
            <div style="color:#666; font-size:0.8rem; margin-bottom:5px;">ì‹œìŠ¤í…œ ë¡œê·¸</div>
            <div id="section-logs"></div>
        </div>
    </main>

    <footer>
        <button id="btn-norm" class="btn-gacha" onclick="game.pull('normal')">
            <span class="font-pixel" style="font-size:1.1rem;">ì¼ë°˜ ë½‘ê¸°</span>
            <span style="font-size:0.8rem; opacity:0.8;" id="cost-norm">100 CP</span>
        </button>
        <button id="btn-prem" class="btn-gacha" onclick="game.pull('premium')">
            <span class="font-pixel" style="font-size:1.1rem;">âœ¨ ê³ ê¸‰ ì¸ë ¥ì†Œ</span>
            <span style="font-size:0.8rem; opacity:0.8;" id="cost-prem">1000 CP</span>
        </button>
    </footer>

    <div id="overlay" class="overlay">
        <div id="pop-card" class="pop-card">
            <div id="pop-rank" class="pop-rank">SSR</div>
            <div id="pop-name" style="font-size:1.5rem; color:#fff; margin-bottom:5px;">ì´ë¦„</div>
            <div id="pop-desc" style="color:#aaa; font-size:0.9rem;">ë‚´ìš©</div>
        </div>
    </div>

    <div id="gameover" class="overlay">
        <h1 style="color:var(--f); font-size:3rem; margin-bottom:20px; font-family:'Black Han Sans';">GAME OVER</h1>
        <p style="color:#ccc; margin-bottom:30px; text-align:center;">
            ë©˜íƒˆì´ í„°ì¡ŒìŠµë‹ˆë‹¤.<br>ê°¤ëŸ¬ë¦¬ê°€ ì¹œëª©ì§ˆë¡œ ë§í–ˆìŠµë‹ˆë‹¤.
        </p>
        <button onclick="game.hardReset()" style="padding:15px 40px; border-radius:30px; border:none; background:var(--f); color:#fff; font-weight:bold; cursor:pointer;">ìƒˆ ì§€êµ¬ íŒŒê¸°</button>
    </div>

<script>
const DB = {
    jobs: {
        N: ['ìœ ë™', 'ëˆˆíŒ…', 'ì§ˆë¬¸ì¶©', 'í•‘í”„', 'ë³µë¶™ëŸ¬'],
        R: ['ì •ë³´ê²Œì´', 'ì§¤ìŸì´', 'ë²ˆì—­ê°€', 'ë¦¬ë·°ì–´'],
        SR: ['24ì‹œê°„ìƒì£¼', 'ì½”ë“œìŠ¬ë ˆì´ì–´', 'ë¶€ê²€ì „ë¬¸ê°€', 'í‚¤ë°°ì™•'],
        SSR: ['ì„œë²„ê´€ë¦¬ì', 'ë¹›ì˜ì™„ì¥', 'AIì•Œë°”', 'ë””ì‹œí˜„ì'],
        UR: ['ê°¤ëŸ¬ë¦¬ì£¼ì¸', 'ì´ˆì›”ì', 'ìš´ì˜ì', 'ê¹€ìœ ì‹'],
        F: ['ë¶„íƒ•', 'ì¢†ëª©ì§ˆ', 'ë„¤ì„ë“œí˜¸ì†Œì¸', 'ì—¬ì™•ë²Œ', 'ë„ë°°ê¸°']
    },
    ranks: ['N', 'R', 'SR', 'SSR', 'UR', 'F'],
    power: { N:2, R:5, SR:15, SSR:40, UR:100, F:-10 }
};

const SAVE_KEY = "pasdak_v24_full_merge";

class Game {
    constructor() {
        this.cp = 1000;
        this.stress = 0; // New: ë©˜íƒˆ ìˆ˜ì¹˜
        this.isOver = false;
        
        this.pasdaks = [];
        this.maxSlots = 12;
        this.selected = []; // ìœµí•©ìš©
        this.costNorm = 100;
        this.costPrem = 1000;
        
        this.ui = {
            cp: document.getElementById('ui-cp'),
            stress: document.getElementById('ui-stress'),
            ticker: document.getElementById('ui-ticker'),
            grid: document.getElementById('slot-grid'),
            logs: document.getElementById('section-logs'),
            overlay: document.getElementById('overlay'),
            popCard: document.getElementById('pop-card'),
            popRank: document.getElementById('pop-rank'),
            popName: document.getElementById('pop-name'),
            popDesc: document.getElementById('pop-desc'),
            slot1: document.getElementById('slot-1'),
            slot2: document.getElementById('slot-2'),
            btnFuse: document.getElementById('btn-fuse'),
            btnNorm: document.getElementById('btn-norm'),
            btnPrem: document.getElementById('btn-prem')
        };

        if(localStorage.getItem(SAVE_KEY)) this.loadGame();
        this.render();
        setInterval(() => this.tick(), 1000);
    }

    /* --- GACHA --- */
    pull(type) {
        if(this.isOver) return;
        let cost = type === 'premium' ? this.costPrem : this.costNorm;
        if(this.cp < cost || this.pasdaks.length >= this.maxSlots) {
            if(this.pasdaks.length >= this.maxSlots) alert("ìŠ¬ë¡¯ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤! ìœµí•©í•˜ê±°ë‚˜ í•´ê³ í•˜ì„¸ìš”.");
            return;
        }

        this.cp -= cost;
        if(type==='premium') this.costPrem = Math.floor(this.costPrem * 1.1);
        else this.costNorm = Math.floor(this.costNorm * 1.1);

        const r = Math.random() * 100;
        let rank = 'N';

        if(type === 'premium') {
            if(r < 5) rank = 'UR';
            else if(r < 25) rank = 'SSR';
            else if(r < 65) rank = 'SR';
            else if(r < 95) rank = 'R';
            else rank = 'F'; 
        } else {
            if(r < 2) rank = 'SSR';
            else if(r < 32) rank = 'F';
            else if(r < 42) rank = 'SR';
            else if(r < 62) rank = 'R';
            else rank = 'N';
        }

        this.addPasdak(rank, type === 'premium');
        this.saveGame();
    }

    addPasdak(rank, isPrem) {
        const jobList = DB.jobs[rank];
        const job = jobList[Math.floor(Math.random() * jobList.length)];
        const name = (Math.random()<0.5?'ìœ ë™':'ê³ ë‹‰') + Math.floor(Math.random()*999);
        
        const p = {
            id: Math.random().toString(36).substr(2, 9),
            rank, name, job,
            lv: 1, exp: 0,
            power: DB.power[rank],
            revealed: false,
            revealTimer: isPrem ? 3 : 8
        };
        
        this.pasdaks.push(p);
        this.showPop(p, true);
        this.render();
    }

    /* --- ACTIONS (Fusion, Fire) --- */
    toggleSelect(id) {
        if(this.isOver) return;
        const idx = this.selected.indexOf(id);
        if(idx > -1) this.selected.splice(idx, 1);
        else {
            if(this.selected.length >= 2) this.selected.shift();
            this.selected.push(id);
        }
        this.render();
        this.updateAltar();
    }

    fire(e, id) {
        e.stopPropagation(); // ì¹´ë“œ ì„ íƒ ë°©ì§€
        if(!confirm("ì •ë§ í•´ê³ í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë¹„ìš© ë°˜í™˜ ì—†ìŒ)")) return;
        
        this.pasdaks = this.pasdaks.filter(p => p.id !== id);
        this.selected = this.selected.filter(sid => sid !== id);
        this.log(`ğŸš« [í•´ê³ ] ì¸ì› ê°ì¶• ì™„ë£Œ.`, 'l-sys');
        
        // í•´ê³  ì‹œ ì•½ê°„ì˜ ìŠ¤íŠ¸ë ˆìŠ¤ ê°ì†Œ
        this.stress = Math.max(0, this.stress - 2);
        
        this.render();
        this.updateAltar();
        this.saveGame();
    }

    updateAltar() {
        const p1 = this.pasdaks.find(p => p.id === this.selected[0]);
        const p2 = this.pasdaks.find(p => p.id === this.selected[1]);

        this.ui.slot1.className = p1 ? `altar-slot filled` : `altar-slot`;
        this.ui.slot1.innerText = p1 ? `[${p1.revealed?p1.rank:'?'}]` : "ì„ íƒ1";
        this.ui.slot1.style.borderColor = p1 && p1.revealed ? this.getRankColor(p1.rank) : '#444';

        this.ui.slot2.className = p2 ? `altar-slot filled` : `altar-slot`;
        this.ui.slot2.innerText = p2 ? `[${p2.revealed?p2.rank:'?'}]` : "ì„ íƒ2";
        this.ui.slot2.style.borderColor = p2 && p2.revealed ? this.getRankColor(p2.rank) : '#444';

        this.ui.btnFuse.disabled = this.selected.length !== 2 || this.cp < 300;
    }

    fuse() {
        if(this.selected.length !== 2 || this.cp < 300) return;
        this.cp -= 300;

        const p1 = this.pasdaks.find(p => p.id === this.selected[0]);
        const p2 = this.pasdaks.find(p => p.id === this.selected[1]);
        
        this.pasdaks = this.pasdaks.filter(p => !this.selected.includes(p.id));
        this.selected = [];

        // Logic
        const scoreMap = {N:1, R:2, SR:3, SSR:4, UR:5, F:0};
        const s1 = scoreMap[p1.revealed ? p1.rank : 'N']; 
        const s2 = scoreMap[p2.revealed ? p2.rank : 'N'];
        const avg = (s1 + s2) / 2;
        
        const r = Math.random();
        let newRank = 'N';
        
        if (r < 0.15) newRank = 'F'; // ìœµí•© ì‹¤íŒ¨
        else if (r < 0.25 && avg >= 4) newRank = 'UR';
        else if (avg >= 3.5) newRank = 'SSR';
        else if (avg >= 2.5) newRank = 'SR';
        else if (avg >= 1.5) newRank = 'R';
        else newRank = 'N';

        const jobList = DB.jobs[newRank];
        const newP = {
            id: Math.random().toString(36).substr(2,9),
            rank: newRank,
            name: "í‚¤ë©”ë¼" + Math.floor(Math.random()*99),
            job: jobList[Math.floor(Math.random()*jobList.length)],
            lv: 1, exp: 0,
            power: DB.power[newRank],
            revealed: true,
            revealTimer: 0
        };
        this.pasdaks.push(newP);
        
        const logType = newRank === 'UR' ? 'l-ur' : (newRank === 'F' ? 'l-fail' : 'l-sys');
        this.log(`ğŸ§¬ [ìœµí•©] ${p1.name} + ${p2.name} â†’ [${newRank}] ${newP.name}`, logType);
        
        if(newRank === 'UR') this.showPop(newP, false);
        
        this.render();
        this.updateAltar();
        this.saveGame();
    }

    /* --- GAME LOOP --- */
    tick() {
        if(this.isOver) return;

        let gain = 0;
        let stressDelta = 0;

        // Fê¸‰ ê°¯ìˆ˜ íŒŒì•…
        const fCount = this.pasdaks.filter(p => p.revealed && p.rank === 'F').length;
        stressDelta += fCount * 0.5; // Fê¸‰ì€ ìˆ¨ì‰¬ê¸°ë§Œ í•´ë„ ìŠ¤íŠ¸ë ˆìŠ¤ ìœ ë°œ

        this.pasdaks.forEach(p => {
            // 1. Reveal
            if (!p.revealed) {
                p.revealTimer--;
                if (p.revealTimer <= 0) {
                    p.revealed = true;
                    this.log(`ğŸ” [ì •ì²´] ${p.name} = [${p.rank}] í™•ì •!`, p.rank=='F'?'l-fail':'l-sys');
                    this.createFloatText(p.rank, `card-${p.id}`, this.getRankColor(p.rank));
                }
            }

            // 2. Production & Exp
            let production = p.power + (p.lv * (p.rank=='UR'?5:1));
            if(p.rank === 'F') production = -10; // Fê¸‰ì€ ì†í•´
            
            gain += production;
            
            p.exp++;
            if (p.exp >= p.lv * 20) { 
                p.lv++; p.exp = 0;
                if(Math.random() < 0.2) this.createFloatText("Level Up!", `card-${p.id}`, "#2ecc71");
            }

            // 3. Cooperation Events (New Feature)
            if(p.revealed && Math.random() < 0.03) { // 3% Chance
                this.handleEvent(p);
            }
        });

        // 4. Update Stats
        if(gain !== 0) this.cp += gain;
        
        // ì ìê°€ ë‚˜ë©´ ìŠ¤íŠ¸ë ˆìŠ¤ ì¦ê°€, í‘ìë©´ ì•½ê°„ ê°ì†Œ
        if(gain < 0) stressDelta += 1;
        else if(gain > 100) stressDelta -= 0.2;

        this.stress = Math.min(100, Math.max(0, this.stress + stressDelta));

        if(this.stress >= 100) {
            this.isOver = true;
            document.getElementById('gameover').style.display = 'flex';
        }

        // Ticker Update
        this.updateTicker();
        
        this.render();
        this.saveGame();
    }

    handleEvent(p) {
        // Fê¸‰ ì¢†ëª©ì§ˆ
        if(p.rank === 'F') {
            const partners = this.pasdaks.filter(t => t.id !== p.id && t.rank === 'F' && t.revealed);
            if(partners.length > 0) {
                const partner = partners[Math.floor(Math.random()*partners.length)];
                this.log(`ğŸ¤® [ì¢†ëª©] ${p.name} & ${partner.name}: ì—¬ë¡  ì¡°ì‘ ì‹œë„!`, 'l-coop-bad');
                this.createFloatText("ì¢†ëª©", `card-${p.id}`, "#d63031");
                this.stress += 5;
            }
        }
        // ê³ ìœ„ì§(SR, SSR, UR) ì •ì˜êµ¬í˜„
        else if(['SR','SSR','UR'].includes(p.rank)) {
            const targets = this.pasdaks.filter(t => t.rank === 'F');
            if(targets.length > 0 && Math.random() < 0.5) {
                const target = targets[0]; // Fê¸‰ ì ë°œ
                // ìë™ í•´ê³  ê¸°ëŠ¥ (20% í™•ë¥ )
                if(Math.random() < 0.2) {
                    this.log(`âš–ï¸ [ìˆ™ì²­] ${p.name}: ë¶„íƒ• ${target.name} ê²€ê±° ë° ì°¨ë‹¨!`, 'l-coop-good');
                    this.pasdaks = this.pasdaks.filter(x => x.id !== target.id);
                    this.stress = Math.max(0, this.stress - 10);
                } else {
                    this.log(`ğŸ›¡ï¸ [ë°©ì–´] ${p.name}: ë¶„íƒ•ê¸€ ì‚­ì œ ì²˜ë¦¬.`, 'l-coop-good');
                    this.stress = Math.max(0, this.stress - 2);
                }
                this.createFloatText("ì¼í•œë‹¤", `card-${p.id}`, "#00cec9");
            }
        }
    }

    updateTicker() {
        if(this.stress > 80) {
            this.ui.ticker.innerText = "ğŸš¨ ê²½ê³ : ê°¤ëŸ¬ë¦¬ í­íŒŒ 5ë¶„ ì „! ë©˜íƒˆì´ ìœ„íƒœë¡­ìŠµë‹ˆë‹¤!";
            this.ui.ticker.style.color = "red";
        } else if(Math.random() < 0.01) {
            const msgs = ["ì‹¤ë²  ë“±ê·¹!", "ìœ ì… í­ì£¼ ì¤‘...", "ì„œë²„ê°€ ë¶ˆì•ˆì •í•©ë‹ˆë‹¤.", "ìƒˆë²½ë°˜ ì í˜¸ ì‹œì‘", "ì•¼ì§¤ ë‚šì‹œ ì£¼ì˜"];
            this.ui.ticker.innerText = "ğŸ“¢ ì†ë³´: " + msgs[Math.floor(Math.random()*msgs.length)];
            this.ui.ticker.style.color = "#e67e22";
        }
    }

    /* --- RENDER & UI --- */
    render() {
        this.ui.cp.innerText = Math.floor(this.cp);
        this.ui.stress.style.width = this.stress + "%";
        document.getElementById('ui-count').innerText = this.pasdaks.length;
        
        document.getElementById('cost-norm').innerText = this.costNorm + " CP";
        document.getElementById('cost-prem').innerText = this.costPrem + " CP";
        this.ui.btnNorm.disabled = this.cp < this.costNorm || this.pasdaks.length >= this.maxSlots;
        this.ui.btnPrem.disabled = this.cp < this.costPrem || this.pasdaks.length >= this.maxSlots;
        
        // Grid
        this.ui.grid.innerHTML = '';
        this.pasdaks.forEach(p => {
            const el = document.createElement('div');
            const isSel = this.selected.includes(p.id);
            const rClass = p.revealed ? p.rank : 'Hidden';
            
            el.className = `card ${rClass} ${isSel ? 'selected' : ''}`;
            el.id = `card-${p.id}`;
            el.onclick = () => this.toggleSelect(p.id);
            
            el.innerHTML = `
                <div class="c-header">
                    <span class="c-rank ${rClass}">${p.revealed ? p.rank : '???'}</span>
                    <button class="btn-fire" onclick="game.fire(event, '${p.id}')">í•´ê³ </button>
                </div>
                <div class="c-name">${p.name}</div>
                <div class="c-job">${p.revealed ? p.job : 'ì‹¬ì‚¬ ì¤‘...'}</div>
                <div class="c-status">
                    <span>Lv.${p.lv}</span>
                    <span>${p.revealed ? (p.power+(p.lv*2))+' P' : '?'}</span>
                </div>
            `;
            this.ui.grid.appendChild(el);
        });
    }

    log(msg, cls) {
        const d = document.createElement('div');
        d.className = `log ${cls||''}`; d.innerText = msg;
        this.ui.logs.appendChild(d);
        this.ui.logs.scrollTop = this.ui.logs.scrollHeight;
    }

    createFloatText(txt, cardId, color) {
        const card = document.getElementById(cardId);
        if(!card) return;
        const el = document.createElement('div');
        el.className = 'float-txt';
        el.innerText = txt;
        el.style.color = color;
        el.style.left = '30%'; el.style.top = '40%';
        card.appendChild(el);
        setTimeout(() => el.remove(), 900);
    }

    showPop(p, hidden=false) {
        const colors = this.getRankColor(p.rank);
        
        if (hidden) {
            this.ui.popRank.innerText = "???";
            this.ui.popRank.style.color = "#fff";
            this.ui.popName.innerText = p.name;
            this.ui.popDesc.innerText = "ìˆ˜ìŠµ ì™„ì¥ (ì •ì²´ ë¶ˆëª…)";
            this.ui.popCard.style.borderColor = "#fff";
        } else {
            this.ui.popRank.innerText = p.rank;
            this.ui.popRank.style.color = colors;
            this.ui.popName.innerText = p.name;
            this.ui.popDesc.innerText = `[${p.job}] íƒ„ìƒ!`;
            this.ui.popCard.style.borderColor = colors;
        }
        
        const ol = this.ui.overlay;
        ol.classList.remove('active'); void ol.offsetWidth; ol.classList.add('active');
        setTimeout(()=>ol.classList.remove('active'), 1000);
    }

    getRankColor(r) {
        const map = {UR:'#00cec9', SSR:'#f1c40f', SR:'#9b59b6', R:'#3498db', N:'#7f8c8d', F:'#e74c3c'};
        return map[r] || '#fff';
    }

    saveGame() {
        if(this.isOver) return;
        const data = { cp: this.cp, stress: this.stress, pasdaks: this.pasdaks, costNorm: this.costNorm, costPrem: this.costPrem };
        localStorage.setItem(SAVE_KEY, JSON.stringify(data));
    }

    loadGame() {
        try {
            const d = JSON.parse(localStorage.getItem(SAVE_KEY));
            if(d) {
                this.cp = d.cp; this.stress = d.stress || 0; 
                this.pasdaks = d.pasdaks;
                this.costNorm = d.costNorm; this.costPrem = d.costPrem;
            }
        } catch(e) { console.log("Save error"); }
    }

    hardReset() {
        if(confirm("ì´ˆê¸°í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { localStorage.removeItem(SAVE_KEY); location.reload(); }
    }
}

window.game = new Game();
</script>
</body>
</html>
